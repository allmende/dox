<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](http://doctoc.herokuapp.com/)*

- [v8 Crankshaft](#v8-crankshaft)
  - [Components](#components)
    - [Base Compiler](#base-compiler)
    - [Runtime Profiler](#runtime-profiler)
    - [Optimizing Compiler](#optimizing-compiler)
    - [Deoptimization Support](#deoptimization-support)
  - [Optimized Mode vs. Unoptimized Mode](#optimized-mode-vs-unoptimized-mode)
    - [Causes for Deoptimization](#causes-for-deoptimization)
      - [Modifying Object Shape](#modifying-object-shape)
  - [Resources](#resources)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# v8 Crankshaft

## Components

### Base Compiler 

- is used for all code initially
- generates code quickly without heavy optimizations
- compilation with the base compiler is very fast generates little code

### Runtime Profiler 

- monitors the running system and identifies hot code

### Optimizing Compiler 

- recompiles and optimizes hot code identified by the runtime profiler
- uses static single assignment form to perform optimizations
  - loop-invariant code motion
  - linear-scan register allocation
  - inlining.
- optimization decisions are based on type information collected while running the code produced by the base compiler

### Deoptimization Support 

- allows the optimizing compiler to be optimistic in the assumptions it makes when generating code
- deoptimization support allows to bail out to the code generated by the base compiler if the assumptions in the
  optimized code turn out to be too optimistic

## Optimized Mode vs. Unoptimized Mode

[watch](http://youtu.be/VhpdsjBUS3g?t=18m53s)

- all code starts unoptimized
- if function executes a lot it becomes **hot**
- hot function is optimized 
  - optimistically 
  - lots of assumptions made from the calls made to that function so far
- if assumption is violated
  - function deoptimized
  - normal to occur
  - more info about about function collected
  - *better* optimization attempted
  - if assumptions are violated again, deoptimized again and start over
- too many deoptimizations cause function to be sent to *deoptimization hell*
  - considered not optimizable and no optimization is **ever** attempted again
- certain constructs like `try/catch` are considered not optimizable and functions containing it go straight to
  *deoptimization hell*

None of this can be diagnosed with Chrome Devtools at this point.

### Causes for Deoptimization

#### Modifying Object Shape

[watch](http://youtu.be/VhpdsjBUS3g?t=21m00s)

- added fields (order matters) to object generate id of hidden class
- adding more fields later on generates new class id which results in code using Point that now gets Point' to be
  deoptimized

[watch](http://youtu.be/VhpdsjBUS3g?t=21m45s)

```js
function Point(x, y) {
  this.x = x;
  this.y = y;
}

var p = new Point(1, 2); // => hidden Point class created

// ....

p.z = 3;                 // => another hidden class (Point') created
```

- `Point` class created, code still deoptimized
- functions that have `Point` argument are optimized
- `z` property added which causes `Point'` class to be created
- functions that get passed `Point'` but were optimized for `Point` get deoptimized
- later functions get optimized again, this time supporting `Point` and `Point'` as argument


## Resources

- [video: accelerating oz with v8](https://www.youtube.com/watch?v=VhpdsjBUS3g) (unable to find slides)
- [chromium blog announcement 2010](http://blog.chromium.org/2010/12/new-crankshaft-for-v8.html)
- [wingo: closer look at crankshaft 8/2011](http://wingolog.org/archives/2011/08/02/a-closer-look-at-crankshaft-v8s-optimizing-compiler)
- [wingo: inside full-codegen 4/2013](http://wingolog.org/archives/2013/04/18/inside-full-codegen-v8s-baseline-compiler)
- [tour of crankshaft 4/2013](http://jayconrod.com/posts/54/a-tour-of-v8-crankshaft-the-optimizing-compiler)
